import React, { useState, useEffect } from "react";
import { css } from "styled-components";
import axios from "axios";
import { motion } from "framer-motion";

import { Svg, Path } from "components/svg";
import { MotionBox } from "components/box";
import { Text } from "components/typography";

const Vk = () => (
  <Svg>
    <Path d="M22.9565677 15.88382085c-.52254192-.62724848-1.11636357-1.18942695-1.69063119-1.73310836-.20419432-.19336032-.41532503-.39326068-.61885874-.592038-.58430888-.57129488-.6055805-.78592682-.14295584-1.43484329.32006518-.44729852.65942015-.89519159.98761082-1.32835307.29767053-.39299644.60551444-.79940325.90054253-1.20713128l.06057786-.08383131c.56389606-.78024558 1.1470819-1.58704766 1.45743612-2.56032326.08059433-.25677881.16521838-.6346473-.02827407-.9506167-.19336033-.31570516-.56845426-.412022-.833821-.45700948-.13126305-.02226253-.26160125-.02530134-.3825588-.02530134l-3.69287176-.00264243-.03052015-.00026425c-.55834693 0-.93462996.26312067-1.15025282.80448994-.20584584.51725704-.43197238 1.06807303-.69000635 1.59180405-.51349157 1.04290381-1.16564502 2.2440896-2.10932533 3.24590353l-.0399008.0426093c-.11144478.11976845-.2376872.25539153-.32997432.25539153-.01413704 0-.02952923-.0027085-.04696932-.00819155-.19547427-.07616825-.32667127-.54936265-.32072578-.76947765.00006606-.0030388.00013212-.0060776.00013212-.00911641l-.00257638-4.26819635c0-.01479764-.00105697-.02946317-.00297274-.0441287-.09393864-.69383789-.30203055-1.12574421-1.08828767-1.27973223-.02087526-.00416183-.04221293-.00620972-.06348455-.00620972H9.25804223c-.62559696 0-.97030286.2542685-1.2943317.63484548-.08746466.10173383-.26952857.31352515-.17928935.57043609.09156044.26074247.38876854.31649789.4855478.33459858.48039504.09142832.75117877.38526731.8278755.89869282.1339055.89155824.15035467 1.84316586.05179177 2.99480596-.02748134.32006518-.08184948.56726516-.1714281.77846194-.02080919.04928145-.09459924.2101398-.16984263.21020586-.02391406 0-.09307985-.00938065-.21905803-.0961847-.29786871-.2040622-.5158037-.49525876-.76987402-.8549605-.86434114-1.22153255-1.58975615-2.56719359-2.21799554-4.11480287-.23299689-.56970942-.6681402-.88865156-1.22582652-.89803221-.61278114-.0093146-1.16835352-.01380674-1.6982282-.01380674-.57895794 0-1.11570295.00535094-1.63983033.016251-.4486858.0079273-.75904002.14242735-.92234263.40006495-.16356685.2578358-.15293104.59653015.03164319 1.00650425 1.47751864 3.28474736 2.81716813 5.67304797 4.3438361 7.74419008 1.06972455 1.44924457 2.1426861 2.4523797 3.3763078 3.15665523 1.29968263.7435157 2.7561939 1.10500108 4.45263844 1.10500108.19230336 0 .39114674-.00469032.59164165-.01407097.98576111-.0480263 1.3514744-.40482135 1.39771704-1.36462053.02199829-.49050236.07563976-1.00491878.31676213-1.44362938.15220437-.27639891.29410324-.27639891.34074225-.27639891.08984286 0 .20122158.04135414.32085791.1188436.21456589.14004916.39854556.32766219.54936265.49155934.14196493.1557056.2823444.31299666.42285598.47035379.30321965.33961921.6167448.69073302.94427486 1.02374615.71689316.72937867 1.50665151 1.05017052 2.41373407.9805423h3.3857545c.00720065 0 .01446735-.00026424.021668-.00072667.33737313-.02226253.6295606-.20941313.80164931-.5134255.2131786-.37661334.20888465-.85707444-.0114946-1.2855456-.2500406-.48449082-.57439974-.89842858-.85859384-1.23923689z" />
  </Svg>
);

const Fb = () => (
  <Svg viewBox="0 0 20 19.879">
    <Path d="M20 10c0-5.52285156-4.47714844-10-10-10S0 4.47714844 0 10c0 4.99121094 3.65683594 9.12832031 8.4375 9.87851563V12.890625H5.8984375V10H8.4375V7.796875c0-2.50625 1.49296875-3.890625 3.77714844-3.890625 1.09375 0 2.23847656.1953125 2.23847656.1953125V6.5625h-1.2609375C11.95 6.5625 11.5625 7.33339844 11.5625 8.125V10h2.7734375l-.44335938 2.890625H11.5625v6.98789063C16.34316406 19.1283203 20 14.99121093 20 10z" />
  </Svg>
);

const Ok = () => (
  <Svg>
    <Path d="M9.97439307 16.3447277c-.78415266-.1821476-1.51515881-.44546442-2.2099287-.80299552-.24882232-.12851793-.49377944-.26621572-.7314893-.41405966-.70105085-.43773402-.91895156-1.34074162-.49764464-2.03551151.43338567-.71361274 1.33156176-.9455248 2.04855656-.51068969.7053992.42662157 1.45283245.73680395 2.26500782.88319844 1.59826064.28699118 3.09989125.02270806 4.49909403-.80009662.28554173-.16813624.57398236-.30003623.9146032-.29810363.66046623.0038652 1.23879694.42662157 1.43060754 1.0551999.1927769.63340981-.0473487 1.31899985-.60828601 1.679913-.8740186.56238675-1.8205097.95856986-2.82836088 1.20690903-.0434835.01014615-.08600072.02270806-.14687764.03865201.04106776.04444981.07295567.07923662.10677618.11305713.89576035.89576035 1.79200384 1.79007124 2.68679789 2.68728104.5232516.52470104.63340982 1.24459474.28602488 1.8446672-.5000604.8643556-1.6499577 1.00785118-2.37033455.29182268-.89286145-.88802994-1.7808914-1.77992508-2.67037078-2.66940448-.03188791-.0318879-.06184322-.06619157-.1328663-.14349559-.02947215.05266337-.0454161.10387728-.07827031.1367315-.891412.89479404-1.78282399 1.78813863-2.67810119 2.67906747-.61408381.61263437-1.55187822.60876917-2.14615288-.0019326-.5435439-.55852155-.5590047-1.4455852-.03333736-2.0316463.07102307-.08020292.14832709-.15557434.2236985-.23142892.85517574-.85565888 1.70986833-1.70986831 2.56504406-2.56601035.02947216-.0299553.05991062-.06329267.10580988-.11112453z" />
    <Path d="M17.13516235 7.09387207C17.13565063 4.28918457 14.84744263 2 12.04275513 2c-2.82931519.00769043-5.10157776 2.29492188-5.09674073 5.10351563.00434876 2.79882812 2.25920105 5.08801269 5.0986786 5.08520507 2.8235321-.00097656 5.08998107-2.28674316 5.09046935-5.09484863zm-5.07984924-2.10510254c1.15473938.00280762 2.0934906.94934082 2.0925293 2.10986328-.0009613 1.17797852-.947464 2.10461426-2.14808655 2.1036377-1.13298035-.00097656-2.07174683-.96484375-2.06980896-2.12243653.0019226-1.15576171.95518494-2.09399414 2.12536621-2.09106445z" />
  </Svg>
);

const fetchVkCount = () =>
  new Promise((resolve) => {
    const script = document.createElement("script");
    script.src =
      "https://vk.com/share.php?act=count&url=https://coins-story.gavrusev.vercel.app&format=json";

    document.getElementsByTagName("head")[0].appendChild(script);

    window.VK = { Share: { count: (id, count) => resolve(count) } };
  });

const fetchFbCount = async () => {
  const res = await axios.get("https://graph.facebook.com/", {
    params: {
      id: "https://coins-story.gavrusev.vercel.app",
      fields: "og_object{engagement{count}}",
    },
  });

  try {
    return res.data.og_object.engagement.count;
  } catch {
    return 0;
  }
};

const fetchOkCount = async () => {
  // F'ing CORS
  const res = await axios.get(
    "/api/passthrough",

    {
      params: {
        url: "https://connect.ok.ru/dk",
        "st.cmd": "extLike",
        tp: "json",
        ref: "https://coins-story.gavrusev.vercel.app",
      },
    }
  );

  return res.data.count ?? 0;
};

const icons = {
  vk: <Vk />,
  fb: <Fb />,
  ok: <Ok />,
};

const fetchCount = {
  vk: fetchVkCount,
  fb: fetchFbCount,
  ok: fetchOkCount,
};

const shareLinks = {
  vk: "http://vk.com/share.php?url=coins-story.gavrusev.vercel.app",
  fb:
    "https://www.facebook.com/sharer/sharer.php?u=coins-story.gavrusev.vercel.app",
  ok: "https://connect.ok.ru/offer?url=coins-story.gavrusev.vercel.app",
};

const ShareButton = ({ network, ...props }) => {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const fetchCounts = async () => {
      try {
        const c = await fetchCount[network]();

        setCount(c);
      } catch {}
    };

    fetchCounts();
  }, [network]);

  return (
    <MotionBox
      css={css`
        text-decoration: none;
      `}
      forwardedAs={motion.a}
      variants={{
        initial: { backgroundColor: "rgba(255, 255, 255, 0.3)" },
        hover: { backgroundColor: "rgba(255, 255, 255, 0.4)" },
      }}
      initial={false}
      animate="initial"
      whileHover="hover"
      target="_blank"
      rel="noopener noreferrer"
      href={shareLinks[network]}
      borderRadius={99}
      px={3}
      py={1}
      display="flex"
      alignItems="center"
      mt={[3, 3, 0]}
      {...props}
    >
      {icons[network]}
      <Text fontWeight={900} color="text.light" pl={3}>
        {count}
      </Text>
    </MotionBox>
  );
};

export default ShareButton;
